<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰˜è‚²äººå“¡é¼“å‹µæ©Ÿåˆ¶è©¦è¾¦è¨ˆç•« - æ–°åŒ—å¸‚ä¸‰é‡å€å±…å®¶æ‰˜è‚²æœå‹™ä¸­å¿ƒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FDB813',
            primaryDark: '#E5A511',
            secondary: '#FEF3C7',
            accent: '#FBBF24',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .heart-checkbox { appearance: none; width: 32px; height: 32px; cursor: pointer; position: relative; }
    .heart-checkbox::before { content: 'ğŸ¤'; font-size: 28px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .heart-checkbox:checked::before { content: 'â¤ï¸'; }
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 min-h-screen flex flex-col">
  <div id="app" class="flex-grow"></div>

  <script>
    const SUPABASE_URL = 'https://utszytwaabadivssondj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0c3p5dHdhYWJhZGl2c3NvbmRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ1MDIsImV4cCI6MjA3NzkxMDUwMn0.Tq2RlCaOegGV7I8jYqgFLHOLpm-bic1RTuIpRzuwqaY';

    const EVALUATION_ITEMS = {
      communication: [
        { key: 'communication_1', text: 'æ¸…æ¥šè¡¨é”æ‰˜è‚²ç†å¿µåŠæ‰˜è‚²å…§å®¹' },
        { key: 'communication_2', text: 'ä¸»å‹•åˆ†äº«å¹¼å…’ç”Ÿæ´»èˆ‡æˆé•·ç‹€æ³' },
        { key: 'communication_3', text: 'ç•¶æœ‰ç‰¹æ®Šç‹€æ³æ™‚(å¦‚:ç”Ÿç—…ã€å—å‚·),èƒ½å³æ™‚è¯çµ¡' },
        { key: 'communication_4', text: 'ç•¶æˆ‘æœ‰ç–‘å•æ™‚,æ‰˜è‚²äººå“¡èƒ½ç¢ºå¯¦å›è¦†' },
        { key: 'communication_5', text: 'èˆ‡æ‰˜è‚²äººå“¡æºé€šå¤§è‡´æµæš¢è‰¯å¥½' }
      ],
      activity: [
        { key: 'activity_1', text: 'æä¾›å­©å­å¤§è‡´å®‰å…¨çš„æ´»å‹•ç’°å¢ƒ' },
        { key: 'activity_2', text: 'èƒ½å®‰æ’ä¿ƒé€²å­©å­ç™¼å±•çš„æ´»å‹•' },
        { key: 'activity_3', text: 'èƒ½è€ƒé‡å­©å­çš„ç‰¹è³ªèª¿æ•´æ´»å‹•' },
        { key: 'activity_4', text: 'èƒ½æä¾›æ•™æã€ç©å…·çµ¦å­©å­ä½¿ç”¨' },
        { key: 'activity_5', text: 'æä¾›å¤šå…ƒè±å¯Œçš„æ‰˜è‚²æ´»å‹•' }
      ],
      routine: [
        { key: 'routine_1', text: 'å”åŠ©å­©å­å»ºç«‹è‰¯å¥½ä½œæ¯(å¦‚:åƒã€ç¡ç­‰)' },
        { key: 'routine_2', text: 'å¹«åŠ©å­©å­é¤Šæˆè‰¯å¥½ç”Ÿæ´»ç¿’æ…£(å¦‚:ä¸æŒ‘é£Ÿã€å‹¤æ´—æ‰‹ç­‰)' },
        { key: 'routine_3', text: 'èƒ½å¹«åŠ©å­©å­å»ºç«‹è·Ÿå…¶ä»–å­©å­ç›¸è™•çš„èƒ½åŠ›' },
        { key: 'routine_4', text: 'ä¾å­©å­ç™¼å±•æƒ…æ³å”åŠ©å»ºç«‹è‡ªç†èƒ½åŠ›(å¦‚:ç”¨é¤ã€å¦‚å»ã€æ”¶æ‹¾)' },
        { key: 'routine_5', text: 'ç•¶å­©å­æœ‰è¡Œç‚ºå•é¡Œæ™‚,èƒ½å¦¥é©è¼”å°(å¦‚:å’¬äººã€æ‰“äºº)' }
      ],
      relationship: [
        { key: 'relationship_1', text: 'èƒ½è€ƒé‡æˆ‘çš„éœ€æ±‚,å½ˆæ€§èª¿æ•´æ‰˜è‚²å…§å®¹' },
        { key: 'relationship_2', text: 'èƒ½å…±åŒè¨è«–è‚²å…’å•é¡Œã€å”å•†è™•ç†æ–¹å¼' },
        { key: 'relationship_3', text: 'æ‰˜è‚²äººå“¡èƒ½å°Šé‡æˆ‘çš„æ•™è‚²ç†å¿µèˆ‡æ•™é¤Šæ–¹å¼' },
        { key: 'relationship_4', text: 'æˆ‘æ„Ÿè¦ºèˆ‡æ‰˜è‚²äººå“¡æ˜¯å¤¥ä¼´é—œä¿‚' },
        { key: 'relationship_5', text: 'æˆ‘ç›¸ä¿¡å­©å­å—åˆ°å¦¥å–„çš„ç…§é¡§' }
      ]
    };

    const icons = {
      home: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',
      user: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
      heart: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',
      star: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>'
    };

    let state = {
      user: null, userRole: null, providerData: null, parentData: null, adminData: null,
      adminStats: { totalParents: 0, evaluatedParents: 0 }, assignedProviders: [],
      allProviders: [], selectedProviderForAdmin: null, providerEvaluationsDetail: [],
      currentEvaluation: null, currentComment: null, selectedProvider: null,
      evaluationStats: null, news: [], currentPage: 'home', error: '', loading: false
    };

    function init() { checkUser(); fetchNews(); render(); }
    function toggleElement(id) { const el = document.getElementById(id); if (el) el.classList.toggle('hidden'); }
    
    function checkUser() {
      const stored = sessionStorage.getItem('childcare_user');
      if (stored) {
        state.user = JSON.parse(stored);
        state.userRole = state.user.role;
        if (state.userRole === 'provider') fetchProviderData();
        else if (state.userRole === 'parent') fetchParentData();
        else if (state.userRole === 'admin') fetchAdminData();
      }
    }

    async function fetchNews() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/news?select=*&order=published_date.desc`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
        });
        if (res.ok) { state.news = await res.json(); render(); }
      } catch (e) {}
    }

    // --- å®¶é•·ç«¯ä¿®å¾©é‡é» ---
    async function fetchParentData() {
      state.loading = true; render();
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/parents?user_id=eq.${state.user.id}&select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (res.ok) state.parentData = (await res.json())[0];
        await fetchAssignedProviders();
      } catch (e) {
        state.error = "è®€å–å®¶é•·è³‡æ–™å¤±æ•—";
      } finally {
        state.loading = false; render();
      }
    }

    async function fetchAssignedProviders() {
      try {
        const aRes = await fetch(`${SUPABASE_URL}/rest/v1/parent_provider_assignments?parent_user_id=eq.${state.user.id}&select=provider_id`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (aRes.ok) {
          const assignments = await aRes.json();
          const ids = assignments.map(a => a.provider_id);
          if (ids.length > 0) {
            const pRes = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?id=in.(${ids.join(',')})&select=*`, {
              headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
            });
            if (pRes.ok) state.assignedProviders = await pRes.json();
          } else {
            state.assignedProviders = []; // ç¢ºå®šæ²’æœ‰åˆ†é…
          }
        }
      } catch (e) {
        console.error("åˆ†é…è®€å–éŒ¯èª¤:", e);
      }
    }

    async function fetchParentEvaluation(pid) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/evaluations?parent_user_id=eq.${state.user.id}&provider_id=eq.${pid}&select=*`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
      });
      if (res.ok) state.currentEvaluation = (await res.json())[0] || null;
      render();
    }

    async function fetchParentComment(pid) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/parent_comments?parent_user_id=eq.${state.user.id}&provider_id=eq.${pid}&select=*`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
      });
      if (res.ok) state.currentComment = (await res.json())[0] || null;
      render();
    }

    // --- å…¶ä»–è§’è‰²èˆ‡åŠŸèƒ½ ---
    async function fetchProviderData() {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?user_id=eq.${state.user.id}&select=*`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
      });
      if (res.ok) { state.providerData = (await res.json())[0]; fetchEvaluationStats(); render(); }
    }

    async function fetchEvaluationStats() {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/provider_evaluation_stats?provider_id=eq.${state.providerData.id}&select=*`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
      });
      if (res.ok) { state.evaluationStats = (await res.json())[0] || null; render(); }
    }

    async function fetchAdminData() {
      const adminRes = await fetch(`${SUPABASE_URL}/rest/v1/admins?user_id=eq.${state.user.id}&select=*`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
      });
      if (adminRes.ok) state.adminData = (await adminRes.json())[0];
      await fetchAllProvidersWithStats();
      render();
    }

    async function fetchAllProvidersWithStats() {
      const pRes = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?select=*&order=name`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
      });
      const sRes = await fetch(`${SUPABASE_URL}/rest/v1/provider_evaluation_stats?select=*`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
      });
      if (pRes.ok && sRes.ok) {
        const providers = await pRes.json();
        const stats = await sRes.json();
        state.allProviders = providers.map(p => ({
          ...p, stats: stats.find(s => s.provider_id === p.id) || { total_hearts: 0, total_parents: 0 }
        }));
        await fetchParentStats();
      }
    }

    async function fetchParentStats() {
      const pRes = await fetch(`${SUPABASE_URL}/rest/v1/parents?select=user_id`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
      });
      const eRes = await fetch(`${SUPABASE_URL}/rest/v1/evaluations?select=parent_user_id`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
      });
      if (pRes.ok && eRes.ok) {
        state.adminStats.totalParents = (await pRes.json()).length;
        state.adminStats.evaluatedParents = new Set((await eRes.json()).map(e => e.parent_user_id)).size;
        render();
      }
    }

    async function handleLogin(email, password) {
      state.error = ''; state.loading = true; render();
      try {
        const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
          method: 'POST',
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!data.access_token) { state.error = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'; state.loading = false; render(); return; }
        
        const uid = data.user.id;
        const tk = data.access_token;
        let role = null;

        const pCheck = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?user_id=eq.${uid}&select=id`, { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${tk}` } });
        if (pCheck.ok && (await pCheck.json()).length > 0) role = 'provider';
        if (!role) {
          const paCheck = await fetch(`${SUPABASE_URL}/rest/v1/parents?user_id=eq.${uid}&select=id`, { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${tk}` } });
          if (paCheck.ok && (await paCheck.json()).length > 0) role = 'parent';
        }
        if (!role) {
          const adCheck = await fetch(`${SUPABASE_URL}/rest/v1/admins?user_id=eq.${uid}&select=id`, { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${tk}` } });
          if (adCheck.ok && (await adCheck.json()).length > 0) role = 'admin';
        }

        if (!role) { state.error = 'ç„¡å°æ‡‰èº«ä»½'; state.loading = false; render(); return; }
        
        state.user = { id: uid, email: data.user.email, token: tk, role: role };
        state.userRole = role;
        sessionStorage.setItem('childcare_user', JSON.stringify(state.user));
        location.reload();
      } catch (e) { state.error = 'ç™»å…¥å¤±æ•—'; state.loading = false; render(); }
    }

    function handleLogout() { sessionStorage.removeItem('childcare_user'); location.reload(); }
    function navigateTo(page) { state.currentPage = page; state.error = ''; render(); }

    async function saveEvaluation(providerId, evaluationData) {
      if (!confirm('æäº¤å¾Œä¸å¯ä¿®æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
      const res = await fetch(`${SUPABASE_URL}/rest/v1/evaluations`, {
        method: 'POST',
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...evaluationData, parent_user_id: state.user.id, provider_id: providerId })
      });
      if (res.ok) { alert('æäº¤æˆåŠŸ'); navigateTo('evaluate'); }
    }

    async function saveComment(providerId) {
      const txt = document.getElementById('parentComment').value.trim();
      if (!txt) return;
      if (!confirm('æäº¤ç•™è¨€å¾Œç„¡æ³•ä¿®æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
      const res = await fetch(`${SUPABASE_URL}/rest/v1/parent_comments`, {
        method: 'POST',
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ parent_user_id: state.user.id, provider_id: providerId, comment: txt })
      });
      if (res.ok) { alert('ç•™è¨€å·²é€å‡º'); navigateTo('evaluate'); }
    }

    // --- ä»‹é¢æ¸²æŸ“ ---
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <nav class="bg-gradient-to-r from-yellow-400 via-amber-400 to-yellow-500 shadow-lg">
          <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="navigateTo('home')">
              <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">ğŸ‘¶</div>
              <h1 class="text-xl font-bold text-white hidden sm:block">æ‰˜è‚²äººå“¡é¼“å‹µæ©Ÿåˆ¶</h1>
            </div>
            <div class="flex items-center space-x-4">
              ${state.user ? `
                <button onclick="navigateTo('home')" class="text-white">${icons.home}</button>
                ${state.userRole === 'provider' ? `<button onclick="navigateTo('profile')" class="text-white">${icons.user}</button>` : ''}
                ${state.userRole === 'parent' ? `<button onclick="navigateTo('evaluate')" class="text-white">${icons.heart}</button>` : ''}
                ${state.userRole === 'admin' ? `<button onclick="navigateTo('admin-dashboard')" class="text-white">${icons.star}</button>` : ''}
                <button onclick="handleLogout()" class="px-3 py-1 bg-red-500 text-white rounded text-sm">ç™»å‡º</button>
              ` : `<button onclick="navigateTo('login')" class="px-4 py-2 bg-white text-yellow-600 rounded font-bold">ç™»å…¥</button>`}
            </div>
          </div>
        </nav>
        <div class="flex-grow">
          <main class="max-w-7xl mx-auto px-4 py-10">
            ${state.loading ? `<div class="text-center py-20 text-gray-500">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>` : renderContent()}
          </main>
        </div>
        <footer class="bg-gradient-to-r from-gray-800 to-gray-900 mt-20">
          <div class="max-w-7xl mx-auto px-4 py-10 text-center text-gray-300">
            <div class="space-y-2 mb-6">
              <p class="text-lg font-bold text-white">Â© æ–°åŒ—å¸‚ä¸‰é‡å€å±…å®¶æ‰˜è‚²æœå‹™ä¸­å¿ƒ/å±…æœä¸­å¿ƒ All Rights Reserved.</p>
              <div class="flex flex-col md:flex-row justify-center items-center gap-2 md:gap-6 text-sm">
                <p>åœ°å€ï¼šæ–°åŒ—å¸‚ä¸‰é‡å€ä¸‰å’Œè·¯ä¸‰æ®µ81è™Ÿ2æ¨“</p>
                <p>é›»è©±ï¼š02-29760376</p>
                <p>å‚³çœŸï¼š02-29760375</p>
              </div>
              <p class="text-sm">é›»å­éƒµä»¶ï¼šbaby29760376@gmail.com</p>
            </div>
          </div>
        </footer>
      `;
    }

    function renderContent() {
      switch(state.currentPage) {
        case 'home': return renderHome();
        case 'login': return renderLogin();
        case 'profile': return renderProfile();
        case 'evaluate': return renderEvaluateList();
        case 'evaluate-detail': return renderEvaluateDetail();
        case 'admin-dashboard': return renderAdminDashboard();
        case 'admin-provider-detail': return renderAdminProviderDetail();
        default: return '';
      }
    }

    function renderHome() {
        return `
          <div class="text-center py-20 bg-white rounded-3xl shadow-xl">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">æ­¡è¿ä½¿ç”¨è©•åƒ¹ç³»çµ±</h2>
            <p class="text-gray-500 mb-8">è®“æˆ‘å€‘ä¸€èµ·ç‡Ÿé€ æ›´å¥½çš„æ‰˜è‚²ç’°å¢ƒ</p>
            <div class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto px-4 text-left">
              ${state.news.slice(0, 4).map(n => `<div class="p-4 border-l-4 border-yellow-400 bg-yellow-50"><h4 class="font-bold">${n.title}</h4><p class="text-sm text-gray-600">${n.content}</p></div>`).join('')}
            </div>
          </div>`;
    }

    function renderLogin() {
        return `
          <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border-t-8 border-yellow-400">
            <h3 class="text-2xl font-bold mb-6 text-center">å¸³è™Ÿç™»å…¥</h3>
            ${state.error ? `<p class="text-red-500 mb-4">${state.error}</p>` : ''}
            <input id="email" type="email" placeholder="Email" class="w-full p-3 border mb-4 rounded">
            <input id="password" type="password" placeholder="Password" class="w-full p-3 border mb-6 rounded">
            <button onclick="handleLogin(document.getElementById('email').value, document.getElementById('password').value)" class="w-full bg-yellow-400 text-white p-3 rounded font-bold">é€²å…¥ç³»çµ±</button>
          </div>`;
    }

    function renderProfile() {
        const s = state.evaluationStats || { total_hearts:0, total_parents:0 };
        return `
          <div class="bg-white p-8 rounded-2xl shadow-lg">
            <div class="flex items-center space-x-6 mb-10"><div class="text-6xl">ğŸ‘©â€ğŸ«</div><div><h2 class="text-3xl font-bold">${state.providerData?.name || 'æ‰˜è‚²äººå“¡'}</h2><p class="text-gray-500">${state.providerData?.account || ''}</p></div></div>
            <div class="grid grid-cols-2 gap-4">
              <div class="p-6 bg-red-50 rounded-xl text-center border border-red-100"><p class="text-gray-500 text-sm">ç´¯ç©æ„›å¿ƒ</p><p class="text-4xl font-bold text-red-500">${s.total_hearts}</p></div>
              <div class="p-6 bg-blue-50 rounded-xl text-center border border-blue-100"><p class="text-gray-500 text-sm">è©•åƒ¹å®¶é•·</p><p class="text-4xl font-bold text-blue-500">${s.total_parents}</p></div>
            </div>
          </div>`;
    }

    function renderEvaluateList() {
        if (state.assignedProviders.length === 0) {
            return `
              <div class="text-center py-20 bg-white rounded-3xl shadow-xl px-6">
                <div class="text-6xl mb-4">ğŸ“‹</div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">å°šæœªåˆ†é…å¯è©•åƒ¹çš„äººå“¡</h3>
                <p class="text-gray-500 mb-6">ç³»çµ±æŸ¥ç„¡æ‚¨åä¸‹å°æ‡‰çš„æ‰˜è‚²äººå“¡ï¼Œè‹¥éœ€é€²è¡Œè©•åƒ¹ï¼Œè«‹è¯ç¹«å±…æœä¸­å¿ƒã€‚</p>
                <div class="inline-block bg-amber-50 p-4 rounded-xl border border-amber-200 text-sm">
                    <p><strong>ä¸­å¿ƒé›»è©±ï¼š</strong>02-29760376</p>
                    <p><strong>æœå‹™æ™‚é–“ï¼š</strong>é€±ä¸€è‡³é€±äº” 08:30 - 17:30</p>
                </div>
              </div>`;
        }
        return `
          <div class="grid md:grid-cols-3 gap-6">
            ${state.assignedProviders.map(p => `
              <div class="bg-white p-6 rounded-xl shadow cursor-pointer hover:ring-2 hover:ring-yellow-400 transition" 
                   onclick="(async () => { state.selectedProvider = ${JSON.stringify(p).replace(/"/g, '&quot;')}; await fetchParentEvaluation(p.id); await fetchParentComment(p.id); state.currentPage='evaluate-detail'; render(); })()">
                <div class="text-4xl mb-4 text-center">ğŸ‘©â€ğŸ«</div>
                <h4 class="text-xl font-bold text-center">${p.name}</h4>
                <p class="text-center text-gray-500 text-sm mt-2">é»é¸é–‹å§‹è©•åƒ¹</p>
              </div>`).join('')}
          </div>`;
    }

    function renderEvaluateDetail() {
      const p = state.selectedProvider;
      const locked = !!state.currentEvaluation?.id;
      return `
        <div class="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold italic">æ­£åœ¨è©•åƒ¹ï¼š${p.name}</h2>
            <button onclick="navigateTo('evaluate')" class="text-gray-400 hover:text-gray-600">â† è¿”å›</button>
          </div>
          <form onsubmit="event.preventDefault(); const d={}; Object.values(EVALUATION_ITEMS).flat().forEach(i=>d[i.key]=document.getElementsByName(i.key)[0].checked); saveEvaluation('${p.id}', d);">
            ${Object.entries(EVALUATION_ITEMS).map(([cat, items]) => `
              <div class="mb-8">
                <h3 class="font-bold text-lg mb-4 text-yellow-600 border-b pb-2">${cat === 'communication' ? 'ä¸€ã€ä¿è¦ªæºé€š' : cat === 'activity' ? 'äºŒã€æ´»å‹•å®‰æ’' : cat === 'routine' ? 'ä¸‰ã€ä½œæ¯ç¿’æ…£' : 'å››ã€ä¿è¦ªé—œä¿‚'}</h3>
                ${items.map(i => `<label class="flex items-center space-x-3 mb-3 p-3 bg-gray-50 rounded hover:bg-gray-100 transition"><input type="checkbox" name="${i.key}" ${state.currentEvaluation?.[i.key]?'checked':''} ${locked?'disabled':''} class="heart-checkbox"><span class="text-gray-700">${i.text}</span></label>`).join('')}
              </div>
            `).join('')}
            ${!locked ? `<button type="submit" class="w-full bg-yellow-400 text-white p-4 rounded-xl font-bold text-lg shadow-lg hover:bg-yellow-500 transition">é€å‡ºè©•åƒ¹</button>` : `<div class="p-4 bg-green-50 text-green-700 text-center rounded-xl border border-green-200 font-bold">âœ… å·²å®Œæˆæäº¤ï¼Œè©•åƒ¹å…§å®¹å·²é–å®š</div>`}
          </form>
          <div class="mt-10 pt-10 border-t">
            <h3 class="font-bold mb-4 flex items-center gap-2"><span>ğŸ’¬</span> æ–‡å­—ç•™è¨€ (åƒ…ä¾›ä¸­å¿ƒåƒè€ƒ)</h3>
            ${state.currentComment ? `<div class="p-4 bg-gray-50 rounded-xl italic border">"${state.currentComment.comment}"</div>` : `
              <textarea id="parentComment" class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-yellow-400 outline-none" rows="3" placeholder="æœ‰ä»€éº¼å»ºè­°æƒ³å°ä¸­å¿ƒèªªå—ï¼Ÿ"></textarea>
              <button onclick="saveComment('${p.id}')" class="w-full bg-gray-800 text-white p-3 rounded-xl font-bold hover:bg-black transition">é€å‡ºç•™è¨€</button>`}
          </div>
          <div class="mt-8 p-6 bg-red-50 rounded-xl border-2 border-dashed border-red-200">
             <p class="text-sm text-red-800 font-bold mb-2">ğŸ’¡ è©•åƒ¹ä¿®æ”¹é ˆçŸ¥ï¼š</p>
             <p class="text-xs text-red-700">ç‚ºç¶­è­·ç³»çµ±å…¬æ­£æ€§ï¼Œè©•åƒ¹é€å‡ºå¾Œå³é–å®šã€‚å¦‚ç¢ºæœ‰èª¤å¡«ï¼Œè«‹è‡´é›»å±…æœä¸­å¿ƒ <strong>02-29760376</strong>ï¼Œç”±å·¥ä½œäººå“¡æ ¸å°èº«åˆ†å¾Œæ‰‹å‹•èª¿æ•´ã€‚</p>
          </div>
        </div>`;
    }

    function renderAdminDashboard() {
      return `
        <div class="grid md:grid-cols-3 gap-4 mb-10 text-center">
          <div class="bg-white p-6 rounded-xl shadow border-b-4 border-yellow-400"><p class="text-gray-500">å®¶é•·ç¸½æ•¸</p><p class="text-4xl font-bold text-yellow-500">${state.adminStats.totalParents}</p></div>
          <div class="bg-white p-6 rounded-xl shadow border-b-4 border-green-400"><p class="text-gray-500">å·²è©•åƒ¹æ•¸</p><p class="text-4xl font-bold text-green-500">${state.adminStats.evaluatedParents}</p></div>
          <div class="bg-white p-6 rounded-xl shadow border-b-4 border-blue-400"><p class="text-gray-500">æ‰˜è‚²äººå“¡</p><p class="text-4xl font-bold text-blue-500">${state.allProviders.length}</p></div>
        </div>
        <div class="space-y-4">
          ${state.allProviders.map(p => `
            <div class="bg-white p-5 rounded-xl shadow flex justify-between items-center cursor-pointer hover:bg-gray-50" onclick="selectProviderForAdmin(${JSON.stringify(p).replace(/"/g, '&quot;')})">
              <div class="flex items-center space-x-4"><span class="text-3xl">ğŸ‘©â€ğŸ«</span><div><h4 class="font-bold">${p.name}</h4><p class="text-xs text-gray-400">@${p.account}</p></div></div>
              <div class="flex space-x-8 text-center">
                <div><p class="font-bold text-red-500">${p.stats.total_hearts}</p><p class="text-[10px] text-gray-400 uppercase">Hearts</p></div>
                <button class="bg-gray-100 px-4 py-2 rounded text-sm font-bold">æŸ¥çœ‹æ˜ç´°</button>
              </div>
            </div>`).join('')}
        </div>`;
    }

    function renderAdminProviderDetail() {
      const p = state.selectedProviderForAdmin;
      return `
        <div class="max-w-5xl mx-auto">
          <button onclick="navigateTo('admin-dashboard')" class="mb-6 text-gray-500 hover:text-gray-800">â† è¿”å›ç®¡ç†ç¸½è¦½</button>
          <div class="bg-white p-8 rounded-2xl shadow-xl mb-8 border-t-8 border-blue-500">
            <h2 class="text-3xl font-bold mb-2">${p.name}</h2>
            <p class="text-gray-500 italic">è©•åˆ†æ˜ç´°èˆ‡å®¶é•·ç•™è¨€åˆ—è¡¨</p>
          </div>
          <div class="space-y-6">
            ${state.providerEvaluationsDetail.length === 0 ? `<p class="text-center py-20 text-gray-400">å°šç„¡è©•åƒ¹è³‡æ–™</p>` : state.providerEvaluationsDetail.map(ed => `
              <div class="bg-white p-6 rounded-2xl shadow border-l-8 border-yellow-400">
                <div class="flex justify-between items-start mb-6">
                  <div><h4 class="text-lg font-bold">${ed.parent_name}</h4><p class="text-xs text-gray-400">${ed.updated_at ? new Date(ed.updated_at).toLocaleString() : 'åƒ…ç•™è¨€'}</p></div>
                  <button onclick="toggleElement('detail-${ed.parent_user_id}')" class="text-xs bg-blue-500 text-white px-3 py-1 rounded font-bold">é»é¸æŸ¥çœ‹å‹¾é¸é …</button>
                </div>
                <div id="detail-${ed.parent_user_id}" class="hidden mb-6 p-4 bg-gray-50 rounded-xl grid md:grid-cols-2 lg:grid-cols-4 gap-4 text-[10px]">
                  ${Object.entries(EVALUATION_ITEMS).map(([cat, items]) => `
                    <div><p class="font-bold border-b mb-1 text-gray-600">${cat}</p>
                    ${items.map(i => `<p class="${ed[i.key]?'text-red-500 font-bold':'text-gray-300'}">${ed[i.key]?'â¤ï¸':'âšª'} ${i.text}</p>`).join('')}</div>`).join('')}
                </div>
                ${ed.comment ? `<div class="p-4 bg-amber-50 rounded-xl border border-amber-100 text-amber-900 text-sm italic">" ${ed.comment} "</div>` : ''}
              </div>`).join('')}
          </div>
        </div>`;
    }

    init();
  </script>
</body>
</html>
