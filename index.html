<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰˜è‚²äººå“¡é¼“å‹µæ©Ÿåˆ¶è©¦è¾¦è¨ˆç•«</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FDB813',
            primaryDark: '#E5A511',
            secondary: '#FEF3C7',
            accent: '#FBBF24',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body {
      font-family: 'Noto Sans TC', sans-serif;
    }
    .heart-checkbox {
      appearance: none;
      width: 32px;
      height: 32px;
      cursor: pointer;
      position: relative;
    }
    .heart-checkbox::before {
      content: 'ğŸ¤';
      font-size: 28px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .heart-checkbox:checked::before {
      content: 'â¤ï¸';
    }
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 min-h-screen">
  <div id="app"></div>

  <script>
    // Supabase è¨­å®š
    const SUPABASE_URL = 'https://utszytwaabadivssondj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0c3p5dHdhYWJhZGl2c3NvbmRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ1MDIsImV4cCI6MjA3NzkxMDUwMn0.Tq2RlCaOegGV7I8jYqgFLHOLpm-bic1RTuIpRzuwqaY';

    // è©•åƒ¹é …ç›®å®šç¾© (åŸå§‹å®šç¾©)
    const EVALUATION_ITEMS = {
      communication: [
        { key: 'communication_1', text: 'æ¸…æ¥šè¡¨é”æ‰˜è‚²ç†å¿µåŠæ‰˜è‚²å…§å®¹' },
        { key: 'communication_2', text: 'ä¸»å‹•åˆ†äº«å¹¼å…’ç”Ÿæ´»èˆ‡æˆé•·ç‹€æ³' },
        { key: 'communication_3', text: 'ç•¶æœ‰ç‰¹æ®Šç‹€æ³æ™‚(å¦‚:ç”Ÿç—…ã€å—å‚·),èƒ½å³æ™‚è¯çµ¡' },
        { key: 'communication_4', text: 'ç•¶æˆ‘æœ‰ç–‘å•æ™‚,æ‰˜è‚²äººå“¡èƒ½ç¢ºå¯¦å›è¦†' },
        { key: 'communication_5', text: 'èˆ‡æ‰˜è‚²äººå“¡æºé€šå¤§è‡´æµæš¢è‰¯å¥½' }
      ],
      activity: [
        { key: 'activity_1', text: 'æä¾›å­©å­å¤§è‡´å®‰å…¨çš„æ´»å‹•ç’°å¢ƒ' },
        { key: 'activity_2', text: 'èƒ½å®‰æ’ä¿ƒé€²å­©å­ç™¼å±•çš„æ´»å‹•' },
        { key: 'activity_3', text: 'èƒ½è€ƒé‡å­©å­çš„ç‰¹è³ªèª¿æ•´æ´»å‹•' },
        { key: 'activity_4', text: 'èƒ½æä¾›æ•™æã€ç©å…·çµ¦å­©å­ä½¿ç”¨' },
        { key: 'activity_5', text: 'æä¾›å¤šå…ƒè±å¯Œçš„æ‰˜è‚²æ´»å‹•' }
      ],
      routine: [
        { key: 'routine_1', text: 'å”åŠ©å­©å­å»ºç«‹è‰¯å¥½ä½œæ¯(å¦‚:åƒã€ç¡ç­‰)' },
        { key: 'routine_2', text: 'å¹«åŠ©å­©å­é¤Šæˆè‰¯å¥½ç”Ÿæ´»ç¿’æ…£(å¦‚:ä¸æŒ‘é£Ÿã€å‹¤æ´—æ‰‹ç­‰)' },
        { key: 'routine_3', text: 'èƒ½å¹«åŠ©å­©å­å»ºç«‹è·Ÿå…¶ä»–å­©å­ç›¸è™•çš„èƒ½åŠ›' },
        { key: 'routine_4', text: 'ä¾å­©å­ç™¼å±•æƒ…æ³å”åŠ©å»ºç«‹è‡ªç†èƒ½åŠ›(å¦‚:ç”¨é¤ã€å¦‚å»ã€æ”¶æ‹¾)' },
        { key: 'routine_5', text: 'ç•¶å­©å­æœ‰è¡Œç‚ºå•é¡Œæ™‚,èƒ½å¦¥é©è¼”å°(å¦‚:å’¬äººã€æ‰“äºº)' }
      ],
      relationship: [
        { key: 'relationship_1', text: 'èƒ½è€ƒé‡æˆ‘çš„éœ€æ±‚,å½ˆæ€§èª¿æ•´æ‰˜è‚²å…§å®¹' },
        { key: 'relationship_2', text: 'èƒ½å…±åŒè¨è«–è‚²å…’å•é¡Œã€å”å•†è™•ç†æ–¹å¼' },
        { key: 'relationship_3', text: 'æ‰˜è‚²äººå“¡èƒ½å°Šé‡æˆ‘çš„æ•™è‚²ç†å¿µèˆ‡æ•™é¤Šæ–¹å¼' },
        { key: 'relationship_4', text: 'æˆ‘æ„Ÿè¦ºèˆ‡æ‰˜è‚²äººå“¡æ˜¯å¤¥ä¼´é—œä¿‚' },
        { key: 'relationship_5', text: 'æˆ‘ç›¸ä¿¡å­©å­å—åˆ°å¦¥å–„çš„ç…§é¡§' }
      ]
    };

    const icons = {
      home: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',
      user: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
      logout: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',
      news: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path><path d="M18 14h-8"></path><path d="M15 18h-5"></path><path d="M10 6h8v4h-8V6Z"></path></svg>',
      megaphone: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 11 18-5v12L3 14v-3z"></path><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path></svg>',
      heart: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',
      star: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>'
    };

    let state = {
      user: null, userRole: null, providerData: null, parentData: null, adminData: null,
      adminStats: { totalParents: 0, evaluatedParents: 0 },
      assignedProviders: [], allProviders: [], selectedProviderForAdmin: null,
      providerEvaluationsDetail: [], currentEvaluation: null, currentComment: null,
      selectedProvider: null, evaluationStats: null, news: [], currentPage: 'home', error: ''
    };

    function init() { checkUser(); fetchNews(); render(); }

    // åŸå§‹ fetch é‚è¼¯ä¿æŒä¸è®Š
    function checkUser() {
      const storedUser = sessionStorage.getItem('childcare_user');
      if (storedUser) {
        state.user = JSON.parse(storedUser);
        state.userRole = state.user.role;
        if (state.userRole === 'provider') fetchProviderData();
        else if (state.userRole === 'parent') fetchParentData();
        else if (state.userRole === 'admin') fetchAdminData();
      }
    }

    async function fetchNews() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/news?select=*&order=published_date.desc`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
        });
        if (response.ok) { state.news = await response.json(); render(); }
      } catch (error) { console.error(error); }
    }

    async function fetchProviderData() {
      if (!state.user) return;
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?user_id=eq.${state.user.id}&select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (response.ok) {
          const data = await response.json();
          state.providerData = data[0];
          await fetchEvaluationStats();
          render();
        }
      } catch (error) { console.error(error); }
    }

    async function fetchEvaluationStats() {
      if (!state.providerData) return;
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/provider_evaluation_stats?provider_id=eq.${state.providerData.id}&select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (response.ok) {
          const data = await response.json();
          state.evaluationStats = data[0] || null;
          render();
        }
      } catch (error) { console.error(error); }
    }

    async function fetchAdminData() {
      if (!state.user) return;
      try {
        const adminRes = await fetch(`${SUPABASE_URL}/rest/v1/admins?user_id=eq.${state.user.id}&select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (adminRes.ok) state.adminData = (await adminRes.json())[0];
        await fetchAllProvidersWithStats();
        render();
      } catch (error) { console.error(error); }
    }

    async function fetchAllProvidersWithStats() {
      if (!state.user) return;
      try {
        const providersRes = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?select=*&order=name`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (!providersRes.ok) return;
        const providers = await providersRes.json();
        const statsRes = await fetch(`${SUPABASE_URL}/rest/v1/provider_evaluation_stats?select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        let stats = [];
        if (statsRes.ok) stats = await statsRes.json();
        state.allProviders = providers.map(provider => {
          const stat = stats.find(s => s.provider_id === provider.id);
          return { ...provider, stats: stat || { total_hearts: 0, total_parents: 0, communication_hearts: 0, activity_hearts: 0, routine_hearts: 0, relationship_hearts: 0 } };
        });
        await fetchParentStats();
        await fetchCommentCounts();
      } catch (error) { console.error(error); }
    }

    async function fetchCommentCounts() {
      if (!state.user) return;
      try {
        const commentsRes = await fetch(`${SUPABASE_URL}/rest/v1/parent_comments?select=provider_id`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (commentsRes.ok) {
          const comments = await commentsRes.json();
          const commentCounts = {};
          comments.forEach(comment => { commentCounts[comment.provider_id] = (commentCounts[comment.provider_id] || 0) + 1; });
          state.allProviders.forEach(provider => {
            const count = commentCounts[provider.id] || 0;
            const el = document.getElementById(`comment-count-${provider.id}`);
            if (el) el.textContent = count;
          });
        }
      } catch (error) { console.error(error); }
    }

    async function fetchParentStats() {
      if (!state.user) return;
      try {
        const parentsRes = await fetch(`${SUPABASE_URL}/rest/v1/parents?select=user_id`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (parentsRes.ok) {
          const parents = await parentsRes.json();
          state.adminStats.totalParents = parents.length;
          const evaluationsRes = await fetch(`${SUPABASE_URL}/rest/v1/evaluations?select=parent_user_id`, {
            headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
          });
          if (evaluationsRes.ok) {
            const evaluations = await evaluationsRes.json();
            state.adminStats.evaluatedParents = new Set(evaluations.map(e => e.parent_user_id)).size;
          }
        }
        render();
      } catch (error) { console.error(error); }
    }

    async function fetchProviderDetailForAdmin(providerId) {
      if (!state.user) return;
      try {
        const evaluationsRes = await fetch(`${SUPABASE_URL}/rest/v1/evaluations?provider_id=eq.${providerId}&select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (!evaluationsRes.ok) return;
        const evaluations = await evaluationsRes.json();
        const commentsRes = await fetch(`${SUPABASE_URL}/rest/v1/parent_comments?provider_id=eq.${providerId}&select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        let comments = [];
        if (commentsRes.ok) comments = await commentsRes.json();
        const parentIds = [...new Set([...evaluations.map(e => e.parent_user_id), ...comments.map(c => c.parent_user_id)])];
        if (parentIds.length > 0) {
          const parentsRes = await fetch(`${SUPABASE_URL}/rest/v1/parents?user_id=in.(${parentIds.join(',')})&select=*`, {
            headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
          });
          if (parentsRes.ok) {
            const parents = await parentsRes.json();
            state.providerEvaluationsDetail = evaluations.map(evaluation => {
              const parent = parents.find(p => p.user_id === evaluation.parent_user_id);
              const comment = comments.find(c => c.parent_user_id === evaluation.parent_user_id);
              return { ...evaluation, parent_name: parent ? parent.name : 'æœªçŸ¥å®¶é•·', comment: comment ? comment.comment : null, comment_id: comment ? comment.id : null };
            });
            comments.forEach(comment => {
              if (!evaluations.some(e => e.parent_user_id === comment.parent_user_id)) {
                const parent = parents.find(p => p.user_id === comment.parent_user_id);
                state.providerEvaluationsDetail.push({
                  parent_user_id: comment.parent_user_id, parent_name: parent ? parent.name : 'æœªçŸ¥å®¶é•·', comment: comment.comment, comment_id: comment.id, updated_at: comment.updated_at,
                  communication_1: false, communication_2: false, communication_3: false, communication_4: false, communication_5: false,
                  activity_1: false, activity_2: false, activity_3: false, activity_4: false, activity_5: false,
                  routine_1: false, routine_2: false, routine_3: false, routine_4: false, routine_5: false,
                  relationship_1: false, relationship_2: false, relationship_3: false, relationship_4: false, relationship_5: false
                });
              }
            });
          }
        }
        render();
      } catch (error) { console.error(error); }
    }

    async function selectProviderForAdmin(provider) {
      state.selectedProviderForAdmin = provider;
      await fetchProviderDetailForAdmin(provider.id);
      state.currentPage = 'admin-provider-detail';
      render();
    }

    async function fetchParentData() {
      if (!state.user) return;
      try {
        const parentRes = await fetch(`${SUPABASE_URL}/rest/v1/parents?user_id=eq.${state.user.id}&select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (parentRes.ok) state.parentData = (await parentRes.json())[0];
        await fetchAssignedProviders();
        render();
      } catch (error) { console.error(error); }
    }

    async function fetchAssignedProviders() {
      if (!state.user) return;
      try {
        const assignmentRes = await fetch(`${SUPABASE_URL}/rest/v1/parent_provider_assignments?parent_user_id=eq.${state.user.id}&select=provider_id`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (assignmentRes.ok) {
          const assignments = await assignmentRes.json();
          if (assignments.length === 0) { state.assignedProviders = []; return; }
          const providerIds = assignments.map(a => a.provider_id);
          const providerRes = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?id=in.(${providerIds.join(',')})&select=*`, {
            headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
          });
          if (providerRes.ok) state.assignedProviders = await providerRes.json();
        }
      } catch (error) { console.error(error); }
    }

    async function fetchComment(providerId) {
      if (!state.user) return;
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/parent_comments?parent_user_id=eq.${state.user.id}&provider_id=eq.${providerId}&select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (response.ok) { state.currentComment = (await response.json())[0] || null; }
      } catch (error) { console.error(error); }
    }

    async function fetchEvaluation(providerId) {
      if (!state.user) return;
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/evaluations?parent_user_id=eq.${state.user.id}&provider_id=eq.${providerId}&select=*`, {
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}` }
        });
        if (response.ok) { state.currentEvaluation = (await response.json())[0] || null; render(); }
      } catch (error) { console.error(error); }
    }

    async function saveComment(providerId) {
      if (!state.user || state.currentComment) return;
      const commentText = document.getElementById('parentComment').value.trim();
      if (!commentText) { alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹'); return; }
      if (!confirm('ç¢ºå®šè¦æäº¤ç•™è¨€å—ï¼Ÿæäº¤å¾Œå°‡ç„¡æ³•ä¿®æ”¹ã€‚')) return;
      try {
        const createRes = await fetch(`${SUPABASE_URL}/rest/v1/parent_comments`, {
          method: 'POST',
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
          body: JSON.stringify({ parent_user_id: state.user.id, provider_id: providerId, comment: commentText })
        });
        if (createRes.ok) { alert('ç•™è¨€å·²æˆåŠŸæäº¤ï¼'); await fetchComment(providerId); render(); }
      } catch (error) { console.error(error); }
    }

    async function saveEvaluation(providerId, evaluationData) {
      if (!state.user || state.currentEvaluation) return;
      if (!confirm('ç¢ºå®šè¦æäº¤è©•åƒ¹å—ï¼Ÿæäº¤å¾Œå°‡ç„¡æ³•ä¿®æ”¹ã€‚')) return;
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/evaluations`, {
          method: 'POST',
          headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${state.user.token}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
          body: JSON.stringify({ ...evaluationData, parent_user_id: state.user.id, provider_id: providerId })
        });
        if (response.ok) { alert('è©•åƒ¹å·²æˆåŠŸæäº¤ï¼'); await fetchEvaluation(providerId); render(); }
      } catch (error) { console.error(error); }
    }

    async function handleLogin(email, password) {
      state.error = '';
      if (!email || !password) { state.error = 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼'; render(); return; }
      try {
        const authResponse = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
          method: 'POST', headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const authData = await authResponse.json();
        if (!authData.access_token) { state.error = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'; render(); return; }
        const userId = authData.user.id;
        const token = authData.access_token;
        let userRole = null;
        const pCheck = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?user_id=eq.${userId}&select=id`, { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${token}` } });
        if (pCheck.ok && (await pCheck.json()).length > 0) userRole = 'provider';
        if (!userRole) {
          const paCheck = await fetch(`${SUPABASE_URL}/rest/v1/parents?user_id=eq.${userId}&select=id`, { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${token}` } });
          if (paCheck.ok && (await paCheck.json()).length > 0) userRole = 'parent';
        }
        if (!userRole) {
          const adCheck = await fetch(`${SUPABASE_URL}/rest/v1/admins?user_id=eq.${userId}&select=id`, { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${token}` } });
          if (adCheck.ok && (await adCheck.json()).length > 0) userRole = 'admin';
        }
        if (!userRole) { state.error = 'æ­¤å¸³è™Ÿæœªè¨»å†Šè§’è‰²'; render(); return; }
        state.user = { id: userId, email: authData.user.email, token: token, role: userRole };
        state.userRole = userRole;
        sessionStorage.setItem('childcare_user', JSON.stringify(state.user));
        if (userRole === 'provider') { state.currentPage = 'profile'; fetchProviderData(); }
        else if (userRole === 'parent') { state.currentPage = 'evaluate'; fetchParentData(); }
        else if (userRole === 'admin') { state.currentPage = 'admin-dashboard'; fetchAdminData(); }
      } catch (error) { state.error = 'ç™»å…¥å¤±æ•—'; render(); }
    }

    function handleLogout() { sessionStorage.removeItem('childcare_user'); location.reload(); }

    function navigateTo(page) { state.currentPage = page; state.error = ''; render(); }

    function toggleElement(id) { const el = document.getElementById(id); if (el) el.classList.toggle('hidden'); }

    // --- æ¸²æŸ“éƒ¨åˆ† (å«ä¿®æ”¹) ---

    function render() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <nav class="bg-gradient-to-r from-yellow-400 via-amber-400 to-yellow-500 shadow-lg">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
              <div class="flex items-center space-x-3 cursor-pointer" onclick="navigateTo('home')">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md"><span>ğŸ‘¶</span></div>
                <div><h1 class="text-2xl font-bold text-white">æ‰˜è‚²äººå“¡é¼“å‹µæ©Ÿåˆ¶è©¦è¾¦è¨ˆç•«</h1></div>
              </div>
              <div class="flex items-center space-x-4">
                ${state.user ? `
                  <button onclick="navigateTo('home')" class="text-white">${icons.home}</button>
                  ${state.userRole === 'provider' ? `<button onclick="navigateTo('profile')" class="text-white">${icons.user}</button>` : ''}
                  ${state.userRole === 'parent' ? `<button onclick="navigateTo('evaluate')" class="text-white">${icons.heart}</button>` : ''}
                  ${state.userRole === 'admin' ? `<button onclick="navigateTo('admin-dashboard')" class="text-white">${icons.star}</button>` : ''}
                  <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg">ç™»å‡º</button>
                ` : `<button onclick="navigateTo('login')" class="px-6 py-2 bg-white text-yellow-600 rounded-lg font-semibold">ç™»å…¥</button>`}
              </div>
            </div>
          </div>
        </nav>
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          ${renderPage()}
        </main>
        <footer class="bg-gradient-to-r from-gray-800 to-gray-900 mt-20">
          <div class="max-w-7xl mx-auto px-4 py-10 text-center text-gray-300">
            <p class="text-lg font-bold text-white mb-2">Â© æ–°åŒ—å¸‚ä¸‰é‡å€å±…å®¶æ‰˜è‚²æœå‹™ä¸­å¿ƒ/å±…æœä¸­å¿ƒ All Rights Reserved.</p>
            <div class="flex flex-col md:flex-row justify-center gap-4 text-sm mb-2">
              <span>åœ°å€ï¼šæ–°åŒ—å¸‚ä¸‰é‡å€ä¸‰å’Œè·¯ä¸‰æ®µ81è™Ÿ2æ¨“</span>
              <span>é›»è©±ï¼š02-29760376</span>
              <span>å‚³çœŸï¼š02-29760375</span>
            </div>
            <p class="text-sm">é›»å­éƒµä»¶ï¼šbaby29760376@gmail.com</p>
          </div>
        </footer>
      `;
    }

    function renderPage() {
      switch(state.currentPage) {
        case 'home': return renderHome();
        case 'login': return renderLogin();
        case 'profile': return renderProfile();
        case 'evaluate': return renderEvaluate();
        case 'evaluate-detail': return renderEvaluateDetail();
        case 'admin-dashboard': return renderAdminDashboard();
        case 'admin-provider-detail': return renderAdminProviderDetail();
        default: return '';
      }
    }

    function renderHome() {
      return `
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
          <h2 class="text-4xl font-bold mb-4">æ­¡è¿ä¾†åˆ°è©•åƒ¹ç³»çµ±</h2>
          <div class="grid md:grid-cols-2 gap-8 text-left mt-8">
            ${state.news.map(n => `<div class="p-4 border-l-4 border-yellow-400 bg-yellow-50"><h4 class="font-bold">${n.title}</h4><p>${n.content}</p></div>`).join('')}
          </div>
        </div>
      `;
    }

    function renderLogin() {
      return `
        <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl">
          <h2 class="text-3xl font-bold text-center mb-8">ç™»å…¥ç³»çµ±</h2>
          ${state.error ? `<div class="p-4 bg-red-50 text-red-700 mb-4 rounded">${state.error}</div>` : ''}
          <input type="email" id="email" placeholder="é›»å­éƒµä»¶" class="w-full px-4 py-3 border rounded-lg mb-4">
          <input type="password" id="password" placeholder="å¯†ç¢¼" class="w-full px-4 py-3 border rounded-lg mb-6">
          <button onclick="handleLogin(document.getElementById('email').value, document.getElementById('password').value)" class="w-full py-3 bg-yellow-400 text-white font-bold rounded-lg">ç™»å…¥</button>
        </div>
      `;
    }

    function renderProfile() {
      const s = state.evaluationStats || { total_hearts: 0, total_parents: 0 };
      return `
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <h2 class="text-3xl font-bold mb-6">${state.providerData?.name}</h2>
          <div class="grid md:grid-cols-2 gap-6">
            <div class="p-6 bg-red-50 rounded-xl text-center"><p>ç¸½æ„›å¿ƒ</p><p class="text-4xl font-bold text-red-500">${s.total_hearts}</p></div>
            <div class="p-6 bg-blue-50 rounded-xl text-center"><p>è©•åƒ¹äººæ•¸</p><p class="text-4xl font-bold text-blue-500">${s.total_parents}</p></div>
          </div>
        </div>
      `;
    }

    function renderEvaluate() {
      return `
        <div class="grid md:grid-cols-3 gap-6">
          ${state.assignedProviders.map(p => `
            <div class="bg-white p-6 rounded-xl shadow cursor-pointer" onclick="(async () => { state.selectedProvider = ${JSON.stringify(p).replace(/"/g, '&quot;')}; await fetchEvaluation(p.id); await fetchComment(p.id); state.currentPage = 'evaluate-detail'; render(); })()">
              <h3 class="text-xl font-bold text-center">${p.name}</h3>
              <p class="text-center text-gray-500">é»æ“Šé–‹å§‹è©•åƒ¹</p>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderEvaluateDetail() {
      const p = state.selectedProvider;
      const ev = state.currentEvaluation || {};
      const locked = !!ev.id;
      return `
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
          <h2 class="text-2xl font-bold mb-6 italic">è©•åƒ¹å°è±¡ï¼š${p.name}</h2>
          <form onsubmit="event.preventDefault(); const d={}; Object.values(EVALUATION_ITEMS).flat().forEach(i=>d[i.key]=document.getElementsByName(i.key)[0].checked); saveEvaluation('${p.id}', d);">
            ${Object.entries(EVALUATION_ITEMS).map(([cat, items]) => `
              <div class="mb-8">
                <h3 class="font-bold text-lg mb-4 text-yellow-600">${cat === 'communication' ? 'ä¿è¦ªæºé€š' : cat === 'activity' ? 'æ´»å‹•å®‰æ’' : cat === 'routine' ? 'ä½œæ¯ç¿’æ…£' : 'ä¿è¦ªé—œä¿‚'}</h3>
                ${items.map(i => `<label class="flex items-center space-x-3 mb-2 p-2 bg-gray-50 rounded"><input type="checkbox" name="${i.key}" ${ev[i.key]?'checked':''} ${locked?'disabled':''} class="heart-checkbox"><span>${i.text}</span></label>`).join('')}
              </div>
            `).join('')}
            ${!locked ? `<button type="submit" class="w-full py-4 bg-yellow-400 text-white font-bold rounded-lg">æäº¤è©•åƒ¹</button>` : `<div class="p-4 bg-green-100 text-green-700 text-center rounded">å·²å®Œæˆè©•åƒ¹</div>`}
          </form>
          <div class="mt-8 pt-8 border-t">
            <h3 class="font-bold mb-4">æ–‡å­—ç•™è¨€ (åƒ…ä¸­å¿ƒç®¡ç†å“¡å¯è¦‹)</h3>
            ${state.currentComment ? `<div class="p-4 bg-gray-50 rounded">${state.currentComment.comment}</div>` : `
              <textarea id="parentComment" class="w-full p-4 border rounded-lg mb-4" rows="3"></textarea>
              <button onclick="saveComment('${p.id}')" class="w-full py-3 bg-gray-800 text-white rounded-lg">æäº¤ç•™è¨€</button>
            `}
          </div>
          <div class="mt-10 p-4 bg-amber-50 rounded-lg border-2 border-dashed border-amber-200">
            <p class="text-sm text-amber-800">ğŸ’¡ <strong>å¦‚éœ€ä¿®æ”¹è©•åƒ¹ï¼š</strong> è«‹è‡´é›»ä¸­å¿ƒ 02-29760376 æˆ– Email baby29760376@gmail.comï¼Œç”±ç®¡ç†å“¡æ‰‹å‹•èª¿æ•´ã€‚</p>
          </div>
        </div>
      `;
    }

    function renderAdminDashboard() {
      return `
        <div class="grid md:grid-cols-3 gap-6 mb-10 text-center">
          <div class="bg-white p-6 rounded-xl shadow"><p>å®¶é•·ç¸½æ•¸</p><p class="text-4xl font-bold text-yellow-500">${state.adminStats.totalParents}</p></div>
          <div class="bg-white p-6 rounded-xl shadow"><p>å·²è©•åƒ¹æ•¸</p><p class="text-4xl font-bold text-green-500">${state.adminStats.evaluatedParents}</p></div>
          <div class="bg-white p-6 rounded-xl shadow"><p>æ‰˜è‚²äººå“¡</p><p class="text-4xl font-bold text-blue-500">${state.allProviders.length}</p></div>
        </div>
        <div class="space-y-4">
          ${state.allProviders.map(p => `
            <div class="bg-white p-6 rounded-xl shadow flex justify-between items-center cursor-pointer" onclick="selectProviderForAdmin(${JSON.stringify(p).replace(/"/g, '&quot;')})">
              <h4 class="font-bold text-lg">${p.name}</h4>
              <div class="flex space-x-4"><span class="text-red-500">â¤ï¸ ${p.stats.total_hearts}</span><button class="bg-gray-100 px-4 py-2 rounded">è©³æƒ…</button></div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderAdminProviderDetail() {
      const p = state.selectedProviderForAdmin;
      return `
        <div class="max-w-5xl mx-auto">
          <button onclick="navigateTo('admin-dashboard')" class="mb-6 text-gray-500">â† è¿”å›ç¸½è¦½</button>
          <h2 class="text-3xl font-bold mb-8">${p.name} çš„è©³æƒ…</h2>
          <div class="space-y-6">
            ${state.providerEvaluationsDetail.map(ed => `
              <div class="bg-white p-6 rounded-2xl shadow">
                <div class="flex justify-between items-start mb-4">
                  <div><h4 class="font-bold">${ed.parent_name}</h4><p class="text-xs text-gray-400">${ed.updated_at || ''}</p></div>
                  <button onclick="toggleElement('detail-${ed.parent_user_id}')" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded">æŸ¥çœ‹å‹¾é¸ç´°é …</button>
                </div>
                <div id="detail-${ed.parent_user_id}" class="hidden p-4 bg-gray-50 rounded-lg grid md:grid-cols-2 gap-4 text-xs mb-4">
                  ${Object.entries(EVALUATION_ITEMS).map(([cat, items]) => `
                    <div><p class="font-bold border-b mb-1">${cat}</p>
                    ${items.map(i => `<p class="${ed[i.key]?'text-red-500 font-bold':'text-gray-300'}">${ed[i.key]?'â¤ï¸':'âšª'} ${i.text}</p>`).join('')}</div>
                  `).join('')}
                </div>
                ${ed.comment ? `<div class="p-4 bg-amber-50 rounded italic text-sm">ç•™è¨€ï¼š${ed.comment}</div>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    init();
  </script>
</body>
</html>
